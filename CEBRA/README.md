# Prerequisites

Our code relies on **CEBRA**. Please ensure that **CEBRA** is installed before using this code.

## Compatibility

This code was developed and validated on **Ubuntu 22.04** with two **GPUs**, using **Python 3.8.0** and **CEBRA 0.4.0**.

## Installing CEBRA

To install **CEBRA**, follow the instructions provided in their [official documentation](https://cebra.ai/docs/installation.html).

## Dependencies

The following dependencies are used to run this code:

- **CEBRA**: 0.4.0
- **mat73**: 0.62
- **matplotlib**: 3.5.2
- **numpy**: 1.24.3
- **statsmodels**: 0.14.0
- **scipy**: 1.10.1
- **h5py**: 3.10.0

# Reproducing paper results

Our code extracts neural embeddings under two modes: **stimulus mode** and **choice mode**.

Please note that if models are trained from scratch, the generated results may not be identical due to the inherent randomness of CEBRA.

## Step-by-step demo

### Running the code for stimulus mode or choice mode

1. **Activate the CEBRA environment**
   - Open your terminal.
   - Activate the Python environment where CEBRA is installed:
     ```bash
     conda activate cebra  # Or use your virtual environment activation command
     ```

2. **Run stimulus mode code**
   - Navigate to the `code` folder:
     ```bash
     cd /path/to/code
     ```
   - Run the script:
     ```bash
     python demo_1_stimulus_mode.py --root_path /path/to/root folder/ --data_path /path/to/data/ --model_save_path /path/to/save trained stimulus_mode_models/ --device cuda:0 --model_trained False
     ```
     ```bash
     python demo_2_stimulus_mode_ablation.py --root_path /path/to/root folder/ --data_path /path/to/data/ --model_save_path /path/to/save trained stimulus_mode_models/ --device cuda:0 --model_trained True
     ```

     **Notes**:
     - Set the variable **`model_trained`** to `False` when running the `demo_1` file for the first time.
     - Set the variable **`model_trained`** to `True` when running the `demo_2` file, as `demo_2` requires the trained models generated by `demo_1`.

3. **Run choice mode code**
   - Navigate to the `code` folder:
     ```bash
     cd /path/to/code
     ```
   - Run the script:
     ```bash
     python demo_3_choice_mode.py --root_path /path/to/root folder/ --data_path /path/to/data/ --model_save_path /path/to/save trained choice_mode_models/ --device cuda:1 --model_trained False
     ```
     ```bash
     python demo_4_choice_mode_ablation.py --root_path /path/to/root folfer/ --data_path /path/to/data/ --model_save_path /path/to/save trained choice_mode_models/ --device cuda:1 --model_trained True
     ```

     **Notes**:
     - Set the variable **`model_trained`** to `False` when running the `demo_3` file for the first time.
     - Set the variable **`model_trained`** to `True` when running the `demo_4` file, as `demo_4` requires the trained models generated by `demo_3`.

4. **Check the results**
   - The code will automatically generate a folder named **`figures`**, and the results will be saved in it.

## Key arguments

- **`--root_path`**  
  The path leads to the parent folder containing the `code` folder.

- **`--data_path`**  
  The path to the folder containing the mice neural activity data, including `cell_idx.mat`, `deconvolved_calcium_signal_APP.mat`, and `deconvolved_calcium_signal_control.mat`. These three .mat files should be downloaded from Zenodo and stored in the same folder. 

- **`--model_save_path`**  
  Specify separate directories to save the trained models for stimulus and choice modes. If a folder does not exist, it will be automatically created based on the provided `model_save_path`. Ensure different directories are used for each mode to avoid overwriting.

- **`--device`**  
  Set the device to `'cuda:0'` or `'cuda:1'` for GPU usage. If no GPU is available, set this to `'cpu'`.

Other arguments are defined in the `default_ops.py` file located in the `choice_mode_functions` or `stimulus_mode_functions` folder.